<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SzakiPush ‚Äì Webes push enged√©lyez≈ë oldal</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;500&display=swap" rel="stylesheet">
  <!-- OneSignal v16 SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <style>
    :root{
      --violet:#431385; --bg:#f6f3ff; --card:#fff; --ink:#391d66; --soft:#ece7fc;
      --ok:#12a150; --warn:#e6a700; --err:#c62828; --muted:#6a5b8d;
    }
    body {
      background: var(--bg);
      font-family: 'Montserrat', Arial, sans-serif;
      margin:0; padding:0;
    }
    .container {
      max-width: 480px; margin: 54px auto;
      background: var(--card); border-radius: 24px;
      box-shadow: 0 8px 36px #4f24af14; padding: 32px 28px 28px 28px;
      text-align: center; position: relative; animation: fadein 0.7s;
    }
    @keyframes fadein { from {opacity:0; transform: translateY(20px)} to {opacity:1; transform:none} }
    h1 { font-size: 2.1rem; font-weight: 700; color: var(--violet); margin-bottom: 18px; letter-spacing: -1px;
      display:flex; align-items:center; justify-content:center; gap:13px; }
    .emoji{font-size:2.1rem; margin-right:6px;}
    .info-box{
      background: var(--soft); color: var(--ink); border-radius: 14px; padding:14px 16px; margin-bottom:16px;
      font-size:1.07rem; text-align:center; font-weight:500; line-height:1.44; border-left:5px solid #a87cff;
    }
    .info-box b{ color:#7b38d8; }
    .main-btn, .next-btn, .test-btn{
      margin-top: 18px; font-size: 1.08rem; color:#fff; border:none; padding:13px 23px; border-radius: 12px;
      font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:10px;
      box-shadow:0 2px 12px #9c59ef25; transition: transform .14s, box-shadow .14s, opacity .14s;
    }
    .main-btn{ background: linear-gradient(90deg,#8726e7,#365cd8 70%); }
    .next-btn{ background: linear-gradient(90deg,#4cafff,#807fff 80%); display:none; border-radius:9px; }
    .test-btn{ background: linear-gradient(90deg,#00b26a,#2bce8f 80%); }
    .main-btn:active, .next-btn:active, .test-btn:active{ transform: scale(.97); }
    .thanks{ margin-top: 24px; font-size: 1.13rem; color: var(--ink); font-weight:600; background:#e0ffed;
      border-radius:10px; padding:10px 16px; display:none; animation: fadein .7s; }
    .notice{ margin-top: 18px; font-size: .98rem; color:#443b5e; line-height:1.6; font-weight:500; }

    /* TESZT PANEL */
    .diag {
      max-width: 820px; margin: 24px auto 54px; padding: 18px; background:#ffffff; border-radius:20px;
      box-shadow:0 8px 30px #00000012; border:1px solid #e9e4ff;
    }
    .diag h2{ font-size:1.15rem; color:#2a2260; margin:0 0 10px 0; text-align:left; }
    .checks{ text-align:left; font-size:.95rem; color:#2a225c; }
    .check{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:9px 10px;
      border-bottom:1px dashed #eee; }
    .check small{ color:var(--muted); font-weight:500; }
    .badge{ font-weight:800; border-radius:999px; padding:4px 10px; font-size:.8rem; }
    .ok{ background:#e8f7ef; color:var(--ok); }
    .warn{ background:#fff6dd; color:var(--warn); }
    .err{ background:#ffe8e8; color:var(--err); }
    .log{
      margin-top:12px; background:#0f1020; color:#e8e8ff; border-radius:12px; padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:.86rem; max-height:220px; overflow:auto; line-height:1.4;
      box-shadow: inset 0 0 0 1px #2a2a55;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .muted{ color:#7e73a6; font-size:.9rem; margin-top:8px; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="emoji">üîî</span> SzakiPush ‚Äì Webes push enged√©lyez≈ë oldal</h1>

    <div class="info-box">
      <b>Kattints az enged√©lyez√©shez a b√∂ng√©sz≈ë felugr√≥ ablak√°ban!</b><br><br>
      <b>Figyelem:</b> A munk√°t ezut√°n <b>push √©rtes√≠t√©sben</b> fogod kapni.<br>
      Ha enged√©lyezed a push √ºzeneteket, a k√∂vetkez≈ë l√©p√©sben a regisztr√°ci√≥s ≈±rlap automatikusan megny√≠lik!
    </div>

    <div class="notice">
      A regisztr√°ci√≥hoz el≈ësz√∂r enged√©lyezd a push √ºzeneteket,<br>
      majd t√∂ltsd ki a megny√≠l√≥ Google ≈±rlapot!
    </div>

    <div class="row">
      <button class="main-btn" id="pushBtn">
        <span class="icon">‚úÖ</span> Enged√©lyezem √©s regisztr√°lok
      </button>
      <button class="test-btn" id="selfTestBtn">
        üß™ √ñnellen≈ërz√©s (nem k√©r enged√©lyt)
      </button>
    </div>

    <div class="thanks" id="doneMsg">
      K√∂sz√∂nj√ºk, az √©rtes√≠t√©s enged√©lyezve!<br>
      <span style="font-weight:400">Tov√°bb a regisztr√°ci√≥hoz:</span>
    </div>
    <button class="next-btn" id="nextBtn">
      <span class="icon">üìù</span> Google ≈±rlap kit√∂lt√©se
    </button>
  </div>

  <!-- Diagnosztikai panel -->
  <div class="diag" id="diagPanel">
    <h2>üß≠ Teszt m√≥d / √ñnellen≈ërz√©s</h2>
    <div class="checks" id="checks">
      <!-- Dinamikusan t√∂lt≈ëdik -->
    </div>
    <div class="log" id="log"></div>
    <div class="muted">Tipp: ha a b√∂ng√©sz≈ë blokkolja a felugr√≥kat, a ≈±rlap-link megnyit√°sa hib√°t jelezhet.</div>
  </div>

  <script>
    // ====== KONFIG ======
    const APP_ID = "os_v2_org_zwupsdpxofapbkx5qoxo62qtpa5fs3up5lrutln3dklvjivka7ylppvebxqzwiklcryg3et4daxqpm7ctjx5uoe7sfy7mbaxjcuab5y";
    const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfwmK4o09-j7fxWj_gqVe7tf1Z1grngHYUfsA0N2FECY5oljA/viewform";

    // ====== KISEG√çT≈êK ======
    const $ = sel => document.querySelector(sel);
    const logEl = $('#log');
    const checksEl = $('#checks');

    function log(msg, obj) {
      const time = new Date().toISOString().split('T')[1].replace('Z','');
      if (obj !== undefined) {
        logEl.textContent += `[${time}] ${msg}: ${safeStringify(obj)}\n`;
      } else {
        logEl.textContent += `[${time}] ${msg}\n`;
      }
      logEl.scrollTop = logEl.scrollHeight;
      console.debug(msg, obj ?? "");
    }
    function safeStringify(v){
      try { return typeof v === 'string' ? v : JSON.stringify(v); }
      catch(e){ return String(v); }
    }

    function setCheck(id, label, status, detail) {
      let row = document.getElementById(id);
      if (!row) {
        row = document.createElement('div');
        row.className = 'check';
        row.id = id;
        row.innerHTML = `<div><b>${label}</b><br><small></small></div><span class="badge"></span>`;
        checksEl.appendChild(row);
      }
      const badge = row.querySelector('.badge');
      const small = row.querySelector('small');
      small.textContent = detail || '';
      badge.className = 'badge ' + (status==='ok'?'ok':status==='warn'?'warn':'err');
      badge.textContent = status==='ok' ? '‚úî OK' : status==='warn' ? '‚ö† Figyelem' : '‚ùå Hiba';
    }

    function supportsNotifications() {
      return 'Notification' in window;
    }
    function isSecureContextPage(){
      return location.protocol === 'https:' || location.hostname === 'localhost';
    }
    function popupTest(){
      let w = null;
      try { w = window.open('about:blank','_blank'); }
      catch(e){ /* ignore */ }
      if (w && !w.closed) { w.close(); return true; }
      return false;
    }

    // ====== ALAP ELLEN≈êRZ√âSEK ======
    async function baselineDiagnostics() {
      setCheck('chk_env','Oldal k√∂rnyezet','ok', `${location.protocol}//${location.host}${location.pathname}`);
      if (!isSecureContextPage()) setCheck('chk_env','Oldal k√∂rnyezet','warn','Nem https / nem localhost ‚Äì push probl√©m√°s lehet.');

      const notif = supportsNotifications();
      setCheck('chk_notif_api','√ârtes√≠t√©si API t√°mogat√°s', notif?'ok':'err', notif?'El√©rhet≈ë':'Nem t√°mogatott a b√∂ng√©sz≈ëben');

      const serviceWorkerSupport = 'serviceWorker' in navigator;
      setCheck('chk_sw','Service Worker t√°mogat√°s', serviceWorkerSupport?'ok':'err', serviceWorkerSupport?'El√©rhet≈ë':'Hi√°nyzik');

      const permission = (window.Notification && Notification.permission) || 'ismeretlen';
      setCheck('chk_perm','Jelenlegi √©rtes√≠t√©si jogosults√°g', 
        permission==='granted'?'ok':permission==='default'?'warn':'err',
        permission);

      const canPopup = popupTest();
      setCheck('chk_popup','Felugr√≥ ablak nyithat√≥', canPopup?'ok':'warn', canPopup?'Enged√©lyezettnek t≈±nik':'Lehet, hogy blokkolva van');

      // SDK bet√∂lt√©s diagn√≥zis: window.OneSignalDeferred l√©tez√©se
      const sdkLoaded = !!window.OneSignalDeferred || !!window.OneSignal;
      setCheck('chk_sdk','OneSignal SDK bet√∂ltve', sdkLoaded?'ok':'err', sdkLoaded?'Igen':'Nem');
      log('Baseline k√©sz', { permission, serviceWorkerSupport, canPopup, sdkLoaded });
    }

    // ====== ONESIGNAL INIT + FELIRATKOZ√ÅS ======
    async function enablePushAndOpenForm() {
      document.getElementById('pushBtn').disabled = true;

      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        try {
          log('OneSignal.init indul');
          setCheck('chk_init','OneSignal inicializ√°l√°s','warn','Folyamatban...');
          await OneSignal.init({ appId: APP_ID });
          setCheck('chk_init','OneSignal inicializ√°l√°s','ok','Sikeres');
          log('OneSignal.init k√©sz');

          // Ha m√°r granted, ne v√°rjunk a slidedownra
          const perm = Notification.permission;
          if (perm === 'granted') {
            setCheck('chk_perm','Jelenlegi √©rtes√≠t√©si jogosults√°g','ok','granted (kor√°bban enged√©lyezve)');
          }

          // Slidedown prompt (csak ha m√©g nem granted)
          if (Notification.permission !== 'granted') {
            setCheck('chk_prompt','Enged√©lyk√©r√©s (slidedown)','warn','Megjelen√≠t√©s k√©r√©se‚Ä¶');
            log('showSlidedownPrompt h√≠v√°s');
            await OneSignal.showSlidedownPrompt();
            setCheck('chk_prompt','Enged√©lyk√©r√©s (slidedown)',
              Notification.permission==='granted'?'ok':
              Notification.permission==='default'?'warn':'err',
              `Permission: ${Notification.permission}`);
            log('showSlidedownPrompt visszat√©rt', Notification.permission);
          } else {
            setCheck('chk_prompt','Enged√©lyk√©r√©s (slidedown)','ok','M√°r enged√©lyezve ‚Äì nem sz√ºks√©ges');
          }

          // Feliratkoz√°s ellen≈ërz√©se
          const isEnabled = await OneSignal.Notifications.isPushEnabled();
          setCheck('chk_enabled','Push enged√©lyezve', isEnabled?'ok':'err', String(isEnabled));
          log('isPushEnabled', isEnabled);

          // Player ID lek√©r√©s
          let playerId = null;
          try {
            playerId = await OneSignal.User.getId();
            setCheck('chk_player','OneSignal Player ID', playerId ? 'ok':'warn', playerId || 'Nincs m√©g');
            log('PlayerID', playerId);
          } catch(e) {
            setCheck('chk_player','OneSignal Player ID','err','Hiba a lek√©r√©skor');
            log('PlayerID hiba', e);
          }

          // UI √°llapot
          if (isEnabled) {
            document.getElementById('doneMsg').style.display = 'block';
            document.getElementById('nextBtn').style.display = 'inline-flex';
            document.getElementById('pushBtn').classList.add('hidden');
            setCheck('chk_ui','UI friss√≠t√©s','ok','K√∂sz√∂n≈ë √ºzenet √©s Tov√°bb gomb l√°that√≥');
          } else {
            setCheck('chk_ui','UI friss√≠t√©s','warn','Nincs enged√©ly ‚Äì marad az Enged√©lyezem gomb');
            alert("Az √©rtes√≠t√©st nem enged√©lyezted ‚Äì friss√≠tsd az oldalt, ha √∫jra pr√≥b√°lod.");
          }

          // Google ≈±rlap megnyit√°s (ha enged√©lyezett)
          if (isEnabled) {
            const win = window.open(FORM_URL, '_blank');
            if (!win) {
              setCheck('chk_form','≈∞rlapmegnyit√°s','warn','A b√∂ng√©sz≈ë blokkolta a felugr√≥ ablakot');
              log('≈∞rlap megnyit√°sa: popup blokkolva lehet');
            } else {
              setCheck('chk_form','≈∞rlapmegnyit√°s','ok','Megnyitva √∫j f√ºl√∂n');
              log('≈∞rlap megnyitva');
            }
          } else {
            setCheck('chk_form','≈∞rlapmegnyit√°s','warn','Nem enged√©lyezett push ‚Äì nem nyitjuk automatikusan');
          }
        } catch (err) {
          setCheck('chk_init','OneSignal inicializ√°l√°s','err','Hiba t√∂rt√©nt');
          log('OneSignal.init/futtat√°s hiba', err);
          alert('Hiba t√∂rt√©nt az enged√©lyez√©s k√∂zben. R√©szletek a napl√≥ban.');
        } finally {
          document.getElementById('pushBtn').disabled = false;
        }
      });
    }

    function goToForm() {
      const win = window.open(FORM_URL, '_blank');
      if (!win) {
        setCheck('chk_form','≈∞rlapmegnyit√°s','warn','A b√∂ng√©sz≈ë blokkolta a felugr√≥ ablakot');
        log('K√©zi ≈±rlap megnyit√°s: popup blokkolva lehet');
      } else {
        setCheck('chk_form','≈∞rlapmegnyit√°s','ok','Megnyitva √∫j f√ºl√∂n');
        log('K√©zi ≈±rlap megnyitva');
      }
    }

    // ====== √ñNELLEN≈êRZ√âS (enged√©lyk√©r√©s n√©lk√ºl) ======
    async function runSelfTest(){
      log('√ñnellen≈ërz√©s indult‚Ä¶');
      await baselineDiagnostics();

      // Pr√≥b√°ljuk ellen≈ërizni, hogy a OneSignal objektum haszn√°lhat√≥-e
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      let sdkReady = false;
      try {
        OneSignalDeferred.push(async (OneSignal) => {
          sdkReady = true;
          setCheck('chk_sdk_ready','OneSignal objektum el√©rhet≈ë','ok','Callback fut');
          log('OneSignal callback fut');
          // Nem h√≠vunk init-et itt, csak valid√°ljuk az objektumot
        });
        // r√∂vid mikrot√ºrelmi id≈ë, hogy a deferred lefusson
        await new Promise(res => setTimeout(res, 400));
        if (!sdkReady) setCheck('chk_sdk_ready','OneSignal objektum el√©rhet≈ë','warn','Lehet, hogy m√©g t√∂lt≈ëdik‚Ä¶');
      } catch(e) {
        setCheck('chk_sdk_ready','OneSignal objektum el√©rhet≈ë','err','Hiba t√∂rt√©nt');
        log('SDK ready ellen≈ërz√©s hiba', e);
      }

      log('√ñnellen≈ërz√©s befejezve.');
    }

    // ====== ESEM√âNYK√ñT√âSEK ======
    document.addEventListener('DOMContentLoaded', async () => {
      await baselineDiagnostics();

      document.getElementById('pushBtn').addEventListener('click', enablePushAndOpenForm);
      document.getElementById('nextBtn').addEventListener('click', goToForm);
      document.getElementById('selfTestBtn').addEventListener('click', runSelfTest);

      // Ha m√°r granted, el≈ëk√©sz√≠tj√ºk az UI-t gyors √°tmenetre
      if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
        log('Permission m√°r granted indul√°skor');
        setCheck('chk_perm','Jelenlegi √©rtes√≠t√©si jogosults√°g','ok','granted (indul√°skor)');
      }
    });
  </script>
</body>
</html>

